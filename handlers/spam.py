from datetime import datetime, time
from data.database import DB_Users as db
import asyncio

async def scheduled_mailing(bot):    
    while True:
        now = datetime.now().time()
        target_time_1 = time(17, 00)  # 17:00
        target_time_2 = time(18, 00)  # 18:00
        target_time_3 = time(19, 00)  # 19:00

        if now.hour == target_time_1.hour and now.minute == target_time_1.minute:
                await send_wave(bot, wave_one)
                await asyncio.sleep(60)  # avoid repeat

        elif now.hour == target_time_2.hour and now.minute == target_time_2.minute:
            await send_wave(bot, wave_two)
            await asyncio.sleep(60)

        elif now.hour == target_time_3.hour and now.minute == target_time_3.minute:
            await send_wave(bot, wave_three)
            await asyncio.sleep(60)
            
        await asyncio.sleep(10)


async def send_wave(bot, wave_func):
    users = await db.get_all_users()
    for user_id in users:
        try:
            await bot.send_message(user_id[0], await wave_func(user_id[1]))
            await asyncio.sleep(0.1)
        except Exception as e:
            print(f"[send_wave] –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id[0]}: {e}")


async def wave_one(name):
    text = f"""üî• –ö–í–ù-–∞—Ç–º–æ—Å—Ñ–µ—Ä–∞ —É–∂–µ –Ω–∞ –ø–æ–¥—Ö–æ–¥–µ! üî•

–ü—Ä–∏–≤–µ—Ç, {name}!

–û—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ 2 —á–∞—Å–∞ –¥–æ —Å–∞–º–æ–≥–æ –ª–µ—Ç–Ω–µ–≥–æ –ö–í–ù –≤ –ù–æ–≤–æ–º –•–µ—Ä—Å–æ–Ω–µ—Å–µ! ‚è≥

üìç –ù–µ –∑–∞–±—É–¥—å: –ù–∞—á–∞–ª–æ –≤ 19:20

–ú–µ—Å—Ç–æ: –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ª "–¢–æ—á–∫–∏ –æ–ø–æ—Ä—ã" (–ú—É–∑–µ–π –ê–Ω—Ç–∏—á–Ω–æ–π –í–∏–∑–∞–Ω—Ç–∏–∏, –≤—Ö–æ–¥ —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –æ—Ç –ö–ü–ü –í–æ—Å—Ç–æ–∫)

–¢–≤–æ–π –∏–º–µ–Ω–Ω–æ–π –±–∏–ª–µ—Ç (–≤ —ç—Ç–æ–º —á–∞—Ç–µ)

üéÅ –°–æ–≤–µ—Ç: –ø—Ä–∏—Ö–æ–¥–∏ –Ω–µ–º–Ω–æ–≥–æ —Ä–∞–Ω—å—à–µ - —Å–º–æ–∂–µ—à—å –ø–µ—Ä–≤—ã–º –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∑–∞ –Ω–∞—à—É –ª–æ–∫–∞—Ü–∏—é –∂–µ—Ç–æ–Ω–∞–º–∏!

–î–æ –≤—Å—Ç—Ä–µ—á–∏ –≤ —ç–ø–∏—Ü–µ–Ω—Ç—Ä–µ —é–º–æ—Ä–∞! üòâ

#–î–µ–Ω—å–ú–æ–ª–æ–¥—ë–∂–∏–ù–• #–ö–í–ù_–ù–æ–≤—ã–π–•–µ—Ä—Å–æ–Ω–µ—Å"""

    return text


async def wave_two(name):
    text = f"""üö® –°—Ç–∞—Ä—Ç—É–µ–º —É–∂–µ —á–µ—Ä–µ–∑ —á–∞—Å! üö®

{name}, —Ç—ã –≥–æ—Ç–æ–≤ –∫ –≤–∑—Ä—ã–≤—É —ç–º–æ—Ü–∏–π? üí•

–ß–µ—Ä–µ–∑ 60 –º–∏–Ω—É—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –Ω–∞—à –ö–í–ù-–±–ª–æ–∫ –≤ —Ä–∞–º–∫–∞—Ö –î–Ω—è –ú–æ–ª–æ–¥—ë–∂–∏!

üìå –ß—Ç–æ –≤–∑—è—Ç—å —Å —Å–æ–±–æ–π:
- –•–æ—Ä–æ—à–µ–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–∏–µ
- –ü–∞—Ä—É –¥—Ä—É–∑–µ–π (—á–µ–º –±–æ–ª—å—à–µ - —Ç–µ–º –≤–µ—Å–µ–ª–µ–µ)
- –¢–≤–æ–π –∏–º–µ–Ω–Ω–æ–π –±–∏–ª–µ—Ç

üìç –ö–∞–∫ –Ω–∞–π—Ç–∏: –∏—â–∏ –∑–¥–∞–Ω–∏–µ –ú—É–∑–µ—è –ê–Ω—Ç–∏—á–Ω–æ–π –í–∏–∑–∞–Ω—Ç–∏–∏, –Ω–∞—à –∑–∞–ª - "–¢–æ—á–∫–∞ –æ–ø–æ—Ä—ã".

–ù–µ –ø—Ä–æ–ø—É—Å—Ç–∏ —Å–∞–º–æ–µ —è—Ä–∫–æ–µ —Å–æ–±—ã—Ç–∏–µ –ª–µ—Ç–∞!‚òÄÔ∏è """

    return text

async def wave_three(name):
    text = f"""üé§ –ü–û–ï–•–ê–õ–ò! –¢—ã —Å –Ω–∞–º–∏? üé§

{name}, –º—ã –ñ–î–Å–ú —Ç–µ–±—è –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å –≤ –û—Å–Ω–æ–≤–Ω–æ–º –∑–∞–ª–µ "–¢–æ—á–∫–∏ –æ–ø–æ—Ä—ã"!

üî• –°–µ–π—á–∞—Å —Å—Ç–∞—Ä—Ç—É–µ—Ç:
- –ò–º–ø—Ä–æ–≤–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–π –±–∞—Ç—Ç–ª
- –ö–í–ù-—Ä–∞–∑–º–∏–Ω–∫–∏ —Å–æ –∑–≤—ë–∑–¥–∞–º–∏ –ª–∏–≥–∏
- –í–∫—É—Å–Ω—ã–µ —à—É—Ç–∫–∏ –∏ –º–æ—Ä–µ –¥—Ä–∞–π–≤–∞

–¢–≤–æ–π –∏–º–µ–Ω–Ω–æ–π –±–∏–ª–µ—Ç –¥–∞—ë—Ç —Ç–µ–±–µ +100 –∫ —Ö–∞—Ä–∏–∑–º–µ —Å–µ–≥–æ–¥–Ω—è! üòé

üìç –¢–æ—á–∫–∞ —Å–±–æ—Ä–∞: –ú—É–∑–µ–π –ê–Ω—Ç–∏—á–Ω–æ–π –í–∏–∑–∞–Ω—Ç–∏–∏ (–æ–±–æ–π–¥–∏ –∑–¥–∞–Ω–∏–µ —Å –æ–±—Ä–∞—Ç–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –æ—Ç –ö–ü–ü –í–æ—Å—Ç–æ–∫).

–ù–µ –æ–ø–æ–∑–¥–∞–π –Ω–∞ —Å–∞–º–æ–µ –∂–∞—Ä–∫–æ–µ —à–æ—É –ª–µ—Ç–∞! üåä"""

    return text